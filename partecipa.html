<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Partecipa — CER Massarosa</title>
  <meta name="description" content="Partecipa alla CER Massarosa: verifica la cabina primaria GSE e invia una richiesta di adesione preliminare." />
  <meta name="theme-color" content="#052e16" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["ui-sans-serif", "system-ui", "Inter", "Segoe UI", "Roboto", "Helvetica", "Arial", "Apple Color Emoji", "Segoe UI Emoji"]
          }
        }
      }
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>

<body class="bg-green-950 text-slate-100 antialiased">
  <!-- Background glow -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-40 left-1/2 h-[520px] w-[520px] -translate-x-1/2 rounded-full bg-emerald-500/25 blur-3xl"></div>
    <div class="absolute top-32 right-[-120px] h-[420px] w-[420px] rounded-full bg-green-400/20 blur-3xl"></div>
    <div class="absolute bottom-[-180px] left-[-120px] h-[520px] w-[520px] rounded-full bg-lime-400/15 blur-3xl"></div>
  </div>

  <header class="sticky top-0 z-50 border-b border-white/10 bg-green-950/70 backdrop-blur">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
      <a href="index.html" class="flex items-center gap-3">
        <img src="logo.png" alt="Logo CER Massarosa" class="h-12 w-auto">
        <div class="leading-tight">
          <div class="text-sm font-semibold tracking-wide text-slate-200">CER MASSAROSA</div>
          <div class="text-xs text-slate-400">La Nostra Energia</div>
        </div>
      </a>

      <nav class="hidden md:flex items-center gap-6 text-sm text-slate-200">
        <a class="hover:text-white" href="index.html#cos-e">Cos’è</a>
        <a class="hover:text-white" href="index.html#come-funziona">Come funziona</a>
        <a class="hover:text-white" href="index.html#documenti">Documenti</a>
        <a class="hover:text-white" href="news/index.html">News</a>
        <a class="hover:text-white" href="faq.html">FAQ</a>
        <a class="hover:text-white" href="index.html#contatti">Contatti</a>
      </nav>

      <div class="flex items-center gap-3">
        <a href="partecipa.html"
           class="hidden sm:inline-flex items-center justify-center rounded-2xl bg-green-500 px-5 py-2.5 text-sm font-extrabold text-slate-950 hover:bg-green-400">
          PARTECIPA
        </a>

        <button id="mobileMenuBtn"
                class="inline-flex md:hidden items-center justify-center rounded-2xl border border-white/15 bg-white/5 px-3 py-2 hover:bg-white/10"
                aria-label="Apri menu"
                aria-expanded="false">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="mobileMenu" class="hidden md:hidden border-t border-white/10 bg-green-950/90">
      <div class="mx-auto max-w-6xl px-4 py-4 grid gap-2 text-sm text-slate-200">
        <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10" href="index.html#cos-e">Cos’è</a>
        <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10" href="index.html#come-funziona">Come funziona</a>
        <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10" href="index.html#documenti">Documenti</a>
        <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10" href="news/index.html">News</a>
        <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10" href="faq.html">FAQ</a>
        <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10" href="index.html#contatti">Contatti</a>
        <a class="mt-2 inline-flex items-center justify-center rounded-2xl bg-green-500 px-6 py-3 text-sm font-extrabold text-slate-950 hover:bg-green-400"
           href="partecipa.html">PARTECIPA</a>
      </div>
    </div>

    <script>
      (function () {
        const btn = document.getElementById("mobileMenuBtn");
        const menu = document.getElementById("mobileMenu");
        if (!btn || !menu) return;

        btn.addEventListener("click", () => {
          const isOpen = !menu.classList.contains("hidden");
          menu.classList.toggle("hidden", isOpen);
          btn.setAttribute("aria-expanded", String(!isOpen));
        });

        menu.querySelectorAll("a").forEach(a => {
          a.addEventListener("click", () => {
            menu.classList.add("hidden");
            btn.setAttribute("aria-expanded", "false");
          });
        });
      })();
    </script>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-10 md:py-14">
    <nav class="text-sm text-slate-300">
      <a class="hover:text-white" href="index.html">Home</a>
      <span class="px-2">/</span>
      <span class="text-slate-100 font-semibold">Partecipa</span>
    </nav>

    <section class="mt-8">
      <div class="max-w-4xl">
        <h1 class="text-4xl font-black tracking-tight md:text-5xl">Partecipa alla CER Massarosa</h1>
        <p class="mt-4 text-slate-200 leading-relaxed">
          Verifica la <span class="font-black text-white">cabina primaria</span> sulla mappa GSE e invia una
          <span class="font-black text-white">richiesta di adesione preliminare</span>.
        </p>
      </div>

      <div class="mt-10 rounded-3xl border border-white/10 bg-white/5 p-8">
        <div class="text-sm font-semibold text-slate-200">Come funziona</div>

        <div class="mt-6 space-y-5">
          <div class="flex items-start gap-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-green-500 text-slate-950 font-black">1</div>
            <div>
              <div class="font-black">Trova la cabina primaria (GSE)</div>
              <div class="text-sm text-slate-300">Cerca con POD o indirizzo sulla mappa ufficiale.</div>
            </div>
          </div>

          <div class="flex items-start gap-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-emerald-300 text-slate-950 font-black">2</div>
            <div>
              <div class="font-black">Seleziona la cabina di Massarosa</div>
              <div class="text-sm text-slate-300">Qui sotto trovi le cabine che insistono sul territorio.</div>
            </div>
          </div>

          <div class="flex items-start gap-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-lime-300 text-slate-950 font-black">3</div>
            <div>
              <div class="font-black">Invia la richiesta preliminare</div>
              <div class="text-sm text-slate-300">Ricevi conferma a schermo e via email.</div>
            </div>
          </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-4">
          <a href="#mappa"
             class="flex-1 inline-flex items-center justify-center rounded-2xl border border-white/15 bg-white/5 px-6 py-3 text-sm font-bold hover:bg-white/10">
            Vai alla Mappa GSE
          </a>

          <a href="#cabine"
             class="flex-1 inline-flex items-center justify-center rounded-2xl bg-green-500 px-6 py-3 text-sm font-extrabold text-slate-950 hover:bg-green-400">
            Seleziona Cabina
          </a>
        </div>
      </div>
    </section>

    <section id="mappa" class="mt-14 border-t border-white/10 pt-14">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div class="max-w-3xl">
          <h2 class="text-3xl font-black tracking-tight md:text-4xl">Mappa GSE — cabine primarie</h2>
          <p class="mt-3 text-slate-200">Usa la mappa ufficiale per individuare la cabina primaria della tua utenza.</p>
        </div>

        <a class="inline-flex w-fit items-center justify-center rounded-2xl border border-white/15 bg-white/5 px-5 py-3 text-sm font-bold hover:bg-white/10"
           href="https://mappe.gse.it/portal/apps/experiencebuilder/experience/?data_id=dataSource_4-19962386703-layer-12%3A1653&id=184cfb3e247b40b0af9dacac4376cd43"
           target="_blank" rel="noopener">
          Apri mappa in nuova scheda →
        </a>
      </div>

      <div class="mt-8 rounded-3xl border border-white/10 bg-white/5 p-4">
        <div class="aspect-[16/9] w-full overflow-hidden rounded-2xl border border-white/10 bg-green-950/40">
          <iframe
            id="gseMapFrame"
            title="Mappa cabine primarie GSE"
            class="h-full w-full"
            loading="lazy"
            referrerpolicy="no-referrer"
            src="https://mappe.gse.it/portal/apps/experiencebuilder/experience/?data_id=dataSource_4-19962386703-layer-12%3A1653&id=184cfb3e247b40b0af9dacac4376cd43">
          </iframe>
        </div>

        <div id="mapFallback" class="mt-4 hidden rounded-2xl border border-white/10 bg-green-950/40 p-4">
          <div class="text-sm font-bold">Embed non disponibile</div>
          <p class="mt-2 text-sm text-slate-300">Se la mappa non compare, aprila in nuova scheda.</p>
          <a class="mt-3 inline-flex items-center justify-center rounded-xl bg-green-500 px-4 py-2 text-sm font-extrabold text-slate-950 hover:bg-green-400"
             href="https://mappe.gse.it/portal/apps/experiencebuilder/experience/?data_id=dataSource_4-19962386703-layer-12%3A1653&id=184cfb3e247b40b0af9dacac4376cd43"
             target="_blank" rel="noopener">
            Apri mappa →
          </a>
        </div>
      </div>
    </section>

    <section id="cabine" class="mt-14 border-t border-white/10 pt-14">
      <h2 class="text-3xl font-black tracking-tight md:text-4xl">Cabine primarie su Massarosa</h2>
      <p class="mt-3 max-w-3xl text-slate-200">Seleziona la cabina e compila il modulo.</p>

      <div class="mt-8 grid gap-4 md:grid-cols-2">
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div class="text-sm text-slate-300">Cabina primaria</div>
          <div class="mt-1 text-2xl font-black">AC001E00628</div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="selectCabinaBtn rounded-xl bg-green-500 px-4 py-2 text-sm font-extrabold text-slate-950 hover:bg-green-400" data-cabina="AC001E00628">Seleziona</button>
            <a class="rounded-xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10" href="#modulo">Vai al modulo →</a>
          </div>
        </div>

        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div class="text-sm text-slate-300">Cabina primaria</div>
          <div class="mt-1 text-2xl font-black">AC001E00706</div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="selectCabinaBtn rounded-xl bg-green-500 px-4 py-2 text-sm font-extrabold text-slate-950 hover:bg-green-400" data-cabina="AC001E00706">Seleziona</button>
            <a class="rounded-xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10" href="#modulo">Vai al modulo →</a>
          </div>
        </div>

        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div class="text-sm text-slate-300">Cabina primaria</div>
          <div class="mt-1 text-2xl font-black">AC001E00594</div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="selectCabinaBtn rounded-xl bg-green-500 px-4 py-2 text-sm font-extrabold text-slate-950 hover:bg-green-400" data-cabina="AC001E00594">Seleziona</button>
            <a class="rounded-xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10" href="#modulo">Vai al modulo →</a>
          </div>
        </div>

        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div class="text-sm text-slate-300">Cabina primaria</div>
          <div class="mt-1 text-2xl font-black">AC001E00627</div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button class="selectCabinaBtn rounded-xl bg-green-500 px-4 py-2 text-sm font-extrabold text-slate-950 hover:bg-green-400" data-cabina="AC001E00627">Seleziona</button>
            <a class="rounded-xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-bold hover:bg-white/10" href="#modulo">Vai al modulo →</a>
          </div>
        </div>
      </div>
    </section>

    <section id="modulo" class="mt-14 border-t border-white/10 pt-14">
      <div class="max-w-3xl">
        <h2 class="text-3xl font-black tracking-tight md:text-4xl">Richiesta di adesione preliminare</h2>
        <p class="mt-3 text-slate-200">Dopo l’invio vedrai l’esito a schermo e riceverai una email di conferma.</p>
      </div>

      <!-- Messaggio browser (esito invio) -->
      <div id="statusBox" class="mt-6 hidden rounded-3xl border border-white/10 bg-white/5 p-6">
        <div id="statusTitle" class="text-sm font-extrabold"></div>
        <div id="statusText" class="mt-2 text-sm text-slate-200"></div>
      </div>

      <div class="mt-8">
        <iframe name="hiddenFrame" id="hiddenFrame" class="hidden"></iframe>

        <form id="adesioneForm" class="rounded-3xl border border-white/10 bg-white/5 p-6 md:p-8" method="POST" target="hiddenFrame">
          <div class="text-sm font-bold">Modulo richiesta</div>

          <div class="mt-5 space-y-4">
            <div>
              <label class="text-sm font-semibold text-slate-200" for="cabina">Cabina primaria *</label>
              <input id="cabina" name="cabina" required readonly
                     class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                     placeholder="Seleziona una cabina sopra" />
              <p class="mt-2 text-xs text-slate-400">Selezionala dalle card: qui si compila da sola.</p>
            </div>

            <!-- Honeypot anti-spam (invisibile) -->
            <div class="hidden">
              <label for="website">Website</label>
              <input id="website" name="website" autocomplete="off" tabindex="-1" />
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <label class="text-sm font-semibold text-slate-200" for="tipo">Sei *</label>
                <select id="tipo" name="tipo" required
                        class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-green-300/60">
                  <option value="" disabled selected>Seleziona…</option>
                  <option>Persona fisica</option>
                  <option>Impresa</option>
                  <option>Ente</option>
                  <option>Produttore (FV)</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-semibold text-slate-200" for="email">Email *</label>
                <input id="email" name="email" type="email" required
                       class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                       placeholder="nome@dominio.it" />
              </div>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <label class="text-sm font-semibold text-slate-200" for="nome">Nome *</label>
                <input id="nome" name="nome" required
                       class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                       placeholder="Mario" />
              </div>
              <div>
                <label class="text-sm font-semibold text-slate-200" for="cognome">Cognome *</label>
                <input id="cognome" name="cognome" required
                       class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                       placeholder="Rossi" />
              </div>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <label class="text-sm font-semibold text-slate-200" for="comune">Comune *</label>
                <input id="comune" name="comune" required value="Massarosa"
                       class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-green-300/60" />
              </div>
              <div>
                <label class="text-sm font-semibold text-slate-200" for="telefono">Telefono (opz.)</label>
                <input id="telefono" name="telefono"
                       class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                       placeholder="+39 ..." />
              </div>
            </div>

            <div>
              <label class="text-sm font-semibold text-slate-200" for="pod">POD (opz.)</label>
              <input id="pod" name="pod"
                     class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                     placeholder="IT001E..." />
            </div>

            <div>
              <label class="text-sm font-semibold text-slate-200" for="note">Note (opz.)</label>
              <textarea id="note" name="note" rows="4"
                        class="mt-1 w-full rounded-2xl border border-white/10 bg-green-950/40 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-green-300/60"
                        placeholder="Es. ho FV, potenza impianto, disponibilità tetto, ecc."></textarea>
            </div>

            <label class="flex items-start gap-3 text-sm text-slate-200">
              <input id="privacy" type="checkbox" required class="mt-1 h-4 w-4 rounded border-white/20 bg-green-950/40">
              <span>
                Acconsento al trattamento dei dati secondo l’informativa privacy
                (<a class="underline decoration-white/25 hover:decoration-white" href="privacy.html" target="_blank" rel="noopener">leggi qui</a>).
              </span>
            </label>

            <button id="submitBtn" type="submit"
                    class="w-full rounded-2xl bg-green-500 px-6 py-3 text-base font-extrabold text-slate-950 hover:bg-green-400">
              Invia richiesta
            </button>

            <p class="text-xs text-slate-400">
              Se non ricevi l’email di conferma entro pochi minuti, controlla Spam/Promozioni.
            </p>
          </div>
        </form>
      </div>
    </section>

    <footer class="mt-14 border-t border-white/10 bg-green-950/70">
      <div class="mx-auto max-w-6xl px-4 py-10">
        <div class="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
          <div class="flex items-center gap-3">
            <img src="logo.png" alt="Logo CER Massarosa" class="h-12 w-auto">
            <div class="leading-tight">
              <div class="text-sm font-semibold tracking-wide text-slate-200">CER MASSAROSA</div>
              <div class="text-xs text-slate-400">La Nostra Energia</div>
            </div>
          </div>

          <div class="flex flex-wrap gap-3 text-sm">
            <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 hover:bg-white/10" href="index.html#documenti">Documenti</a>
            <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 hover:bg-white/10" href="news/index.html">News</a>
            <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 hover:bg-white/10" href="partecipa.html">Partecipa</a>
            <a class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 hover:bg-white/10" href="privacy.html">Privacy</a>
          </div>
        </div>

        <div class="mt-8 border-t border-white/10 pt-6 text-xs text-slate-400">
          © 2026 CER Massarosa — Tutti i diritti riservati.
        </div>
      </div>
    </footer>
  </main>

  <script>
    // ====== URL /exec della Web App ======
    const URL_EXEC = "https://script.google.com/macros/s/AKfycbxEwvip4UKIWdGSMPvB6w1wkDnSAP_CoZoDw5i8axSRM-gzR51tPd8_rS7NUwFMc3SHiA/exec";

    // ===== CABINA SELECTION =====
    const cabinaInput = document.getElementById("cabina");
    function setCabina(code) { if (cabinaInput) cabinaInput.value = code || ""; }

    document.querySelectorAll(".selectCabinaBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const code = btn.getAttribute("data-cabina");
        if (!code) return;
        setCabina(code);
        const modulo = document.getElementById("modulo");
        if (modulo) modulo.scrollIntoView({ behavior: "smooth" });
      });
    });

    const params = new URLSearchParams(window.location.search);
    const cabinaParam = params.get("cabina");
    if (cabinaParam) setCabina(cabinaParam);

    // ===== MESSAGGIO BROWSER (OK/KO) =====
    const form = document.getElementById("adesioneForm");
    const hiddenFrame = document.getElementById("hiddenFrame");
    const submitBtn = document.getElementById("submitBtn");

    const statusBox = document.getElementById("statusBox");
    const statusTitle = document.getElementById("statusTitle");
    const statusText = document.getElementById("statusText");

    let waitingResponse = false;

    function showStatus(kind, title, text) {
      statusBox.classList.remove("hidden");
      statusTitle.textContent = title;
      statusText.textContent = text;

      statusBox.classList.remove("border-green-400/30","bg-green-500/10","border-red-400/30","bg-red-500/10");
      if (kind === "ok") statusBox.classList.add("border-green-400/30","bg-green-500/10");
      else statusBox.classList.add("border-red-400/30","bg-red-500/10");

      statusBox.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      if (!cabinaInput.value.trim()) {
        showStatus("err", "Manca la cabina primaria", "Seleziona prima una cabina nella sezione “Cabine primarie su Massarosa”.");
        return;
      }

      form.action = URL_EXEC;

      waitingResponse = true;
      submitBtn.disabled = true;
      submitBtn.textContent = "Invio in corso…";

      // invio reale (no fetch => no CORS)
      form.submit();

      // timeout KO (se non arriva load dall'iframe)
      setTimeout(() => {
        if (!waitingResponse) return;
        waitingResponse = false;
        submitBtn.disabled = false;
        submitBtn.textContent = "Invia richiesta";
        showStatus("err", "Invio non confermato", "Non ho ricevuto una conferma tecnica. Riprova tra qualche minuto.");
      }, 12000);
    });

    hiddenFrame.addEventListener("load", () => {
      if (!waitingResponse) return;

      waitingResponse = false;
      submitBtn.disabled = false;
      submitBtn.textContent = "Invia richiesta";

      showStatus(
        "ok",
        "Richiesta inviata",
        "Invio completato. Riceverai una email di conferma (controlla anche Spam/Promozioni)."
      );

      // reset senza perdere la cabina selezionata
      const currentCabina = cabinaInput.value;
      form.reset();
      setCabina(currentCabina);
    });

    // ===== MAP FALLBACK =====
    const frame = document.getElementById("gseMapFrame");
    const fallback = document.getElementById("mapFallback");
    setTimeout(() => {
      if (!frame || !fallback) return;
      const rect = frame.getBoundingClientRect();
      if (!rect.width || !rect.height) fallback.classList.remove("hidden");
    }, 2500);
  </script>
</body>
</html>
